<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qarzdorlar Ro'yxati</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-xl mx-auto bg-white shadow-lg rounded-xl p-6">
    <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Qarzdorlar Ro'yxati</h2>

    <!-- Forma -->
    <div class="space-y-4">
      <input type="text" id="nameInput" placeholder="Ism kiriting" class="w-full p-3 border rounded-xl" />
      <input type="number" id="amountInput" placeholder="Qarzdorlik (so'm)" class="w-full p-3 border rounded-xl" />
      <input type="number" id="eggInput" placeholder="Tuxum soni (ixtiyoriy)" class="w-full p-3 border rounded-xl" />
      <input type="number" id="eggPriceInput" placeholder="Tuxum narxi (so'm)" class="w-full p-3 border rounded-xl" />
      <input type="text" id="phoneInput" placeholder="Raqam (ixtiyoriy)" class="w-full p-3 border rounded-xl" />
      <select id="eggType" class="w-full p-3 border rounded-xl">
        <option value="">Tuxum turi (ixtiyoriy)</option>
        <option value="katta">Katta</option>
        <option value="o'rtacha">O'rtacha</option>
        <option value="kichik">Kichik</option>
      </select>
      <button onclick="addDebt()" class="w-full bg-blue-600 text-white py-3 rounded-xl">Qo'shish</button>

      <!-- Qidirish -->
      <div class="flex gap-2 mt-6 flex-col sm:flex-row">
        <input type="text" id="searchInput" placeholder="Qidirish..." class="flex-1 p-3 border rounded-xl" />
        <button onclick="searchExact()" class="bg-green-600 text-white px-6 py-3 rounded-xl">Qidir</button>
      </div>
    </div>

    <div id="message" class="mt-4 text-sm text-red-600"></div>
    <div id="debtList" class="mt-6 space-y-4"></div>
  </div>

  <script>
     let debts = JSON.parse(localStorage.getItem('debts')) || {};

    function saveToLocalStorage() {
      localStorage.setItem('debts', JSON.stringify(debts));
    }

    function showMessage(text) {
      const msg = document.getElementById('message');
      msg.innerHTML = text;
      setTimeout(() => msg.textContent = '', 4000);
    }

    function addDebt() {
      const name = document.getElementById('nameInput').value.trim();
      const amount = parseFloat(document.getElementById('amountInput').value);
      const eggs = parseInt(document.getElementById('eggInput').value) || 0;
      const eggPrice = parseFloat(document.getElementById('eggPriceInput').value) || 0;
      const phone = document.getElementById('phoneInput').value.trim();
      const eggType = document.getElementById('eggType').value;

      if (!name || isNaN(amount)) {
        showMessage("Iltimos, ism va summani toâ€˜gâ€˜ri kiriting.");
        return;
      }

      if (debts[name]) {
        showMessage("Bu ism allaqachon ro'yxatda bor.");
        return;
      }

      // Qarzdorlikka tuxum summasi qoâ€˜shilmaydi!
      debts[name] = { amount, eggs, eggPrice, phone, eggType, history: [] };
      debts[name].history.push({ type: "Qoâ€˜shildi", value: amount, date: new Date().toLocaleString() });
      saveToLocalStorage();
      displayDebts();

      // Tozalash
      document.getElementById('nameInput').value = "";
      document.getElementById('amountInput').value = "";
      document.getElementById('eggInput').value = "";
      document.getElementById('eggPriceInput').value = "";
      document.getElementById('phoneInput').value = "";
      document.getElementById('eggType').value = "";
    }

    function displayDebts(filter = "") {
      const listDiv = document.getElementById('debtList');
      listDiv.innerHTML = "";

      for (const [name, data] of Object.entries(debts)) {
        if (name.toLowerCase().includes(filter.toLowerCase())) {
          const id = name.replace(/\s+/g, '_');
          const eggSum = (data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0;
          const total = (data.amount || 0) + eggSum;
          listDiv.innerHTML += `
            <div class="bg-white border p-4 rounded-xl shadow">
              <div class="flex flex-col gap-2">
                <div>
                  <h3 class="text-xl font-bold">${name}</h3>
                  <p>Qarzdorlik: <span class="text-blue-600 font-semibold">${data.amount || 0} so'm</span></p>
                  ${data.eggs ? `<p class="text-yellow-600">Tuxum: ${data.eggs} ta</p>` : ""}
                  ${data.eggPrice ? `<p>Tuxum narxi: <span class="text-green-600 font-semibold">${data.eggPrice} so'm</span></p>` : ""}
                  ${data.eggType ? `<p>Tuxum turi: ${data.eggType}</p>` : ""}
                  ${eggSum ? `<p>Jami tuxum summasi: <span class="text-green-700 font-semibold">${eggSum} so'm</span></p>` : ""}
                  <p class="font-bold mt-2">Umumiy qarz: <span class="text-purple-700">${total} so'm</span></p>
                  ${data.phone ? `<p>ðŸ“ž ${data.phone}</p>` : ""}
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                  <input type="number" id="add-${id}" placeholder="Qoâ€˜shiladigan summa" class="flex-1 border rounded-xl p-2" />
                  <button onclick="addToDebt('${name}', '${id}')" class="bg-yellow-500 text-white px-4 py-2 rounded-xl">Qoâ€˜shish</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                  <input type="number" id="sub-${id}" placeholder="Ayriladigan summa" class="flex-1 border rounded-xl p-2" />
                  <button onclick="subtractFromDebt('${name}', '${id}')" class="bg-red-500 text-white px-4 py-2 rounded-xl">Ayirish</button>
                </div>
                <button onclick="deleteDebt('${name}')" class="bg-gray-500 text-white px-4 py-2 rounded-xl w-full sm:w-auto">Oâ€˜chirish</button>
                <button onclick="showHistory('${name}')" class="bg-blue-500 text-white px-4 py-2 rounded-xl w-full sm:w-auto">Ma'lumotlar</button>
              </div>
            </div>
          `;
        }
      }
    }

    function addToDebt(name, id) {
      const value = parseFloat(document.getElementById(`add-${id}`).value);
      if (isNaN(value) || value <= 0) return;
      debts[name].amount += value;
      if (!debts[name].history) debts[name].history = [];
      debts[name].history.push({ type: "Qoâ€˜shildi", value, date: new Date().toLocaleString() });
      saveToLocalStorage();
      displayDebts();
    }

    function subtractFromDebt(name, id) {
      const value = parseFloat(document.getElementById(`sub-${id}`).value);
      if (isNaN(value) || value <= 0) return;
      debts[name].amount -= value;
      if (debts[name].amount < 0) debts[name].amount = 0;
      if (!debts[name].history) debts[name].history = [];
      debts[name].history.push({ type: "Ayrildi", value, date: new Date().toLocaleString() });
      saveToLocalStorage();
      displayDebts();
    }

    // O'chirishni tasdiqlash uchun modal qo'shamiz
    if (!document.getElementById('confirmDeleteModal')) {
      const modalDiv = document.createElement('div');
      modalDiv.id = 'confirmDeleteModal';
      modalDiv.style.display = 'none';
      modalDiv.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
      modalDiv.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-xs w-full relative text-center">
          <p class="mb-4 text-lg font-semibold">Haqiqatan ham oâ€˜chirishni xohlaysizmi?</p>
          <div class="flex justify-center gap-4">
            <button id="confirmDeleteYes" class="bg-red-600 text-white px-4 py-2 rounded-xl">Ha</button>
            <button id="confirmDeleteNo" class="bg-gray-400 text-white px-4 py-2 rounded-xl">Yoâ€˜q</button>
          </div>
        </div>
      `;
      document.body.appendChild(modalDiv);
    }

    let deleteName = null;

    function deleteDebt(name) {
      deleteName = name;
      document.getElementById('confirmDeleteModal').style.display = 'flex';
      document.getElementById('confirmDeleteYes').onclick = function() {
        if (deleteName && debts[deleteName]) {
          delete debts[deleteName];
          saveToLocalStorage();
          displayDebts();
        }
        document.getElementById('confirmDeleteModal').style.display = 'none';
        deleteName = null;
      };
      document.getElementById('confirmDeleteNo').onclick = function() {
        document.getElementById('confirmDeleteModal').style.display = 'none';
        deleteName = null;
      };
    }

    function searchExact() {
      const q = document.getElementById('searchInput').value.trim();
      displayDebts(q);
    }

    // Modal uchun div qoâ€˜shamiz
    if (!document.getElementById('historyModal')) {
      const modalDiv = document.createElement('div');
      modalDiv.id = 'historyModal';
      modalDiv.style.display = 'none';
      modalDiv.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
      modalDiv.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-md w-full relative">
          <button onclick="closeHistory()" class="absolute top-2 right-2 text-xl">&times;</button>
          <h3 id="historyTitle" class="text-lg font-bold mb-4"></h3>
          <div id="historyContent"></div>
        </div>
      `;
      document.body.appendChild(modalDiv);
    }

    function showHistory(name) {
      const modal = document.getElementById('historyModal');
      const title = document.getElementById('historyTitle');
      const content = document.getElementById('historyContent');
      title.textContent = `${name} - Oâ€˜zgarishlar tarixi`;
      const history = debts[name].history || [];
      if (history.length === 0) {
        content.innerHTML = "<p>Hali oâ€˜zgarishlar yoâ€˜q.</p>";
      } else {
        content.innerHTML = `<ul class="space-y-2">
          ${history.map(h => `<li>${h.date}: <span class="${h.type === "Qoâ€˜shildi" ? "text-green-600" : "text-red-600"}">${h.type}</span> - <b>${h.value} so'm</b></li>`).join('')}
        </ul>`;
      }
      modal.style.display = 'flex';
    }

    function closeHistory() {
      document.getElementById('historyModal').style.display = 'none';
    }

    displayDebts();
  </script>
</body>
</html>

