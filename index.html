<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qarzdorlar Ro‘yxati</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
   .actions-menu {
  transition: all 0.3s ease;
  min-width: 180px;
  padding: 0.25rem 0;
  border-radius: 0.75rem;
  box-shadow: 0 8px 24px 0 rgba(0,0,0,0.08);
  background: #fff;
  border: 1px solid #e5e7eb;
}

.actions-menu button {
  transition: background 0.2s, color 0.2s;
  width: 100%;
  text-align: left;
  padding: 0.75rem 1.25rem;
  font-size: 1rem;
  color: #374151;
  background: transparent;
  border: none;
  outline: none;
  border-radius: 0.5rem;
  margin-bottom: 2px;
}

.actions-menu button:last-child {
  margin-bottom: 0;
}

.actions-menu button:hover {
  background: #f3f4f6;
  color: #2563eb;
}

.actions-menu button.text-red-600:hover {
  background: #fee2e2;
  color: #dc2626;
}
.history-item {
  background: #f3f4f6;
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 1rem;
  border: 1px solid #c7d2fe;
  box-shadow: 0 2px 8px 0 rgba(59,130,246,0.08);
}
.history-date {
  color: #2563eb;
  font-weight: bold;
  font-size: 1rem;
}
.history-action {
  color: #374151;
  font-size: 1rem;
  margin-top: 0.25rem;
}
    </style>
</head>
<body class="bg-gray-100">
  <div id="authSection" class="flex flex-col items-center justify-center min-h-screen px-2">
    <div class="bg-white p-4 sm:p-8 rounded-xl shadow w-full max-w-sm">
      <h2 class="text-2xl sm:text-3xl font-bold mb-4" id="authTitle">Kirish</h2>
      <input id="email" type="email" placeholder="Email" class="border p-3 rounded-xl w-full mb-2 text-base sm:text-lg" />
      <input id="password" type="password" placeholder="Parol" class="border p-3 rounded-xl w-full mb-4 text-base sm:text-lg" />
      <button onclick="login()" class="bg-blue-600 text-white px-6 py-3 rounded-xl w-full mb-2 text-base sm:text-lg font-bold">Kirish</button>
      <button onclick="window.location.href='register.html'" class="bg-green-600 text-white px-6 py-3 rounded-xl w-full text-base sm:text-lg font-bold">Ro‘yxatdan o‘tish</button>
      <p id="authMsg" class="text-red-600 mt-2 text-base sm:text-lg"></p>
    </div>
  </div>

  <div id="mainSection" style="display:none;">
    <div class="mx-auto p-4 w-full max-w-2xl">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
        <h1 class="text-2xl sm:text-3xl font-bold">Qarzdorlar</h1>
        <button onclick="logout()" class="bg-gray-600 text-white px-6 py-3 rounded-xl w-full sm:w-auto text-base sm:text-lg font-bold">Chiqish</button>
      </div>
      <input id="searchInput" type="text" placeholder="Qarzdor qidirish..." class="border p-3 rounded-xl mb-4 w-full text-base sm:text-lg" oninput="displayDebts()"/>
      <div class="bg-white p-4 rounded-xl shadow mb-4">
        <input id="nameInput" type="text" placeholder="Ism" class="border p-3 rounded-xl mb-2 w-full text-base sm:text-lg" />
        <input id="amountInput" type="number" placeholder="Pul qarzi" class="border p-3 rounded-xl mb-2 w-full text-base sm:text-lg" />
        <input id="eggInput" type="number" placeholder="Tuxum soni" class="border p-3 rounded-xl mb-2 w-full text-base sm:text-lg" />
        <input id="eggPriceInput" type="number" placeholder="Tuxum narxi" class="border p-3 rounded-xl mb-2 w-full text-base sm:text-lg" />
        <input id="phoneInput" type="text" placeholder="Telefon" class="border p-3 rounded-xl mb-2 w-full text-base sm:text-lg" />
        <input id="eggType" type="text" placeholder="Tuxum turi" class="border p-3 rounded-xl mb-2 w-full text-base sm:text-lg" />
        <button onclick="addDebt()" class="bg-blue-600 text-white px-6 py-3 rounded-xl w-full text-base sm:text-lg font-bold">Qo‘shish</button>
      </div>
      <div id="addMsg" class="text-green-600 font-bold mb-2 text-base sm:text-lg" style="display:none;"></div>
      <div id="debtList" class="grid gap-4"></div>
    </div>
  </div>

  <div id="deleteModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-xl w-11/12 max-w-sm text-center">
      <p class="mb-4 text-lg sm:text-xl font-semibold">Haqiqatan ham o‘chirmoqchimisiz?</p>
      <div class="flex gap-4 justify-center">
        <button onclick="confirmDelete()" class="bg-red-600 text-white px-6 py-3 rounded-xl text-base sm:text-lg font-bold">Ha, o‘chir</button>
        <button onclick="cancelDelete()" class="bg-gray-400 text-white px-6 py-3 rounded-xl text-base sm:text-lg font-bold">Bekor</button>
      </div>
    </div>
  </div>

  <div id="editModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-xl w-11/12 max-w-sm text-center">
      <h3 class="mb-4 text-lg sm:text-xl font-semibold">Ma'lumotlarni o‘zgartirish</h3>
      <input id="editName" type="text" placeholder="Ism" class="border p-3 rounded-xl mb-2 w-full" />
      <input id="editAmount" type="number" placeholder="Pul qarzi" class="border p-3 rounded-xl mb-2 w-full" />
      <input id="editEggs" type="number" placeholder="Tuxum soni" class="border p-3 rounded-xl mb-2 w-full" />
      <input id="editEggPrice" type="number" placeholder="Tuxum narxi" class="border p-3 rounded-xl mb-2 w-full" />
      <input id="editPhone" type="text" placeholder="Telefon" class="border p-3 rounded-xl mb-2 w-full" />
      <input id="editEggType" type="text" placeholder="Tuxum turi" class="border p-3 rounded-xl mb-4 w-full" />
      <div class="flex gap-4 justify-center">
        <button onclick="saveEdit()" class="bg-blue-600 text-white px-6 py-3 rounded-xl text-base font-bold">Saqlash</button>
        <button onclick="cancelEdit()" class="bg-gray-400 text-white px-6 py-3 rounded-xl text-base font-bold">Bekor</button>
      </div>
    </div>
  </div>

  <!-- JS kodlar (firebase va functions) -->
  <!-- Siz yuborgan fayldagi JavaScript kodi shu yerga qoʻyiladi -->
<script>
    // Firebase configni o‘zingiznikiga almashtiring!
    const firebaseConfig = {
      apiKey: "AIzaSyAgb0G3chiVfdzRXLaIqPV5R2Hx5Un3S0g",
      authDomain: "e-qarizdorlik.firebaseapp.com",
      projectId: "e-qarizdorlik",
      storageBucket: "e-qarizdorlik.firebasestorage.app",
      messagingSenderId: "975301245533",
      appId: "1:975301245533:web:436f9a6c3afc50fe756bb4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userId = null;
    let debts = {};

    let editId = null;
    let currentEditId = null;

    function showMsg(msg) {
      document.getElementById('authMsg').innerText = msg;
    }

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => showMain())
        .catch(e => showMsg(e.message));
    }

    function register() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => showMain())
        .catch(e => showMsg(e.message));
    }

    function logout() {
      auth.signOut();
      document.getElementById('mainSection').style.display = 'none';
      document.getElementById('authSection').style.display = 'flex';
    }

    function showMain() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('mainSection').style.display = 'block';
      userId = auth.currentUser.uid;
      loadDebts();
    }

    auth.onAuthStateChanged(user => {
      if (user) showMain();
      else {
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('authSection').style.display = 'flex';
      }
    });

    // Qarzdor qo‘shish
    function addDebt() {
      const name = document.getElementById('nameInput').value.trim();
      const amount = parseFloat(document.getElementById('amountInput').value) || 0;
      const eggs = parseInt(document.getElementById('eggInput').value) || 0;
      const eggPrice = parseFloat(document.getElementById('eggPriceInput').value) || 0;
      const phone = document.getElementById('phoneInput').value.trim();
      const eggType = document.getElementById('eggType').value;
      if (!userId) {
        alert("Avval tizimga kiring!");
        return;
      }
      if (!name) {
        alert("Ism kiritilishi shart!");
        return;
      }
      db.collection('debts').add({
        uid: userId,
        name,
        amount,
        eggs,
        eggPrice,
        phone,
        eggType,
        history: []
      }).then(() => {
        // Formani tozalash
        document.getElementById('nameInput').value = "";
        document.getElementById('amountInput').value = "";
        document.getElementById('eggInput').value = "";
        document.getElementById('eggPriceInput').value = "";
        document.getElementById('phoneInput').value = "";
        document.getElementById('eggType').value = "";
        // Xabar ko‘rsatish
        const addMsg = document.getElementById('addMsg');
        addMsg.innerText = "Qarzdor qo‘shildi!";
        addMsg.style.display = "block";
        setTimeout(() => { addMsg.style.display = "none"; }, 2000);
        loadDebts();
      }).catch(e => {
        alert("Xatolik: " + e.message);
      });
    }

    // Qarzdorlarni yuklash
    function loadDebts() {
      db.collection('debts').where('uid', '==', userId).get().then(snapshot => {
        debts = {};
        snapshot.forEach(doc => {
          debts[doc.id] = doc.data();
        });
        displayDebts();
      });
    }

    // O'chirish uchun modal oynani ko'rsatish
    function showDeleteConfirm(id) {
      const modal = document.getElementById('deleteModal');
      modal.style.display = 'flex';
      modal.dataset.id = id;
    }

    // O'chirishni tasdiqlash
    function confirmDelete() {
      const modal = document.getElementById('deleteModal');
      const id = modal.dataset.id;
      db.collection('debts').doc(id).get().then(doc => {
        const data = doc.data();
        if (!data) return;
        const now = new Date();
        const dateStr = now.toLocaleString('uz-UZ');
        const newHistory = (data.history || []);
        newHistory.push({ date: dateStr, action: "O‘chirildi" });
        db.collection('debts').doc(id).update({ history: newHistory }).then(() => {
          db.collection('debts').doc(id).delete().then(() => {
            modal.style.display = 'none';
            loadDebts();
          });
        });
      });
    }

    // O'chirishni bekor qilish
    function cancelDelete() {
      document.getElementById('deleteModal').style.display = 'none';
    }

    function showEditModal(id) {
      editId = id;
      const data = debts[id];
      document.getElementById('editName').value = data.name || "";
      document.getElementById('editAmount').value = data.amount || 0;
      document.getElementById('editEggs').value = data.eggs || 0;
      document.getElementById('editEggPrice').value = data.eggPrice || 0;
      document.getElementById('editPhone').value = data.phone || "";
      document.getElementById('editEggType').value = data.eggType || "";
      document.getElementById('editModal').style.display = 'flex';
    }

    function saveEdit() {
      if (!editId) return;
      const name = document.getElementById('editName').value.trim();
      const amount = parseFloat(document.getElementById('editAmount').value) || 0;
      const eggs = parseInt(document.getElementById('editEggs').value) || 0;
      const eggPrice = parseFloat(document.getElementById('editEggPrice').value) || 0;
      const phone = document.getElementById('editPhone').value.trim();
      const eggType = document.getElementById('editEggType').value;
      const now = new Date();
      const dateStr = now.toLocaleString('uz-UZ');
      db.collection('debts').doc(editId).get().then(doc => {
        const oldData = doc.data() || {};
        const changes = [];

        // Ism
        if ((oldData.name || "") !== name) {
          if (!oldData.name && name) changes.push(`Ism: Qo‘shildi "${name}"`);
          else if (oldData.name && !name) changes.push(`Ism: Ayirildi "${oldData.name}"`);
          else changes.push(`Ism: "${oldData.name || ""}" → "${name}"`);
        }
        // Pul
        if ((oldData.amount || 0) !== amount) {
          if (!oldData.amount && amount) changes.push(`Pul: Qo‘shildi ${amount}`);
          else if (oldData.amount && !amount) changes.push(`Pul: Ayirildi ${oldData.amount}`);
          else changes.push(`Pul: ${oldData.amount || 0} → ${amount}`);
        }
        // Tuxum
        if ((oldData.eggs || 0) !== eggs) {
          if (!oldData.eggs && eggs) changes.push(`Tuxum: Qo‘shildi ${eggs}`);
          else if (oldData.eggs && !eggs) changes.push(`Tuxum: Ayirildi ${oldData.eggs}`);
          else changes.push(`Tuxum: ${oldData.eggs || 0} → ${eggs}`);
        }
        // Tuxum narxi
        if ((oldData.eggPrice || 0) !== eggPrice) {
          if (!oldData.eggPrice && eggPrice) changes.push(`Tuxum narxi: Qo‘shildi ${eggPrice}`);
          else if (oldData.eggPrice && !eggPrice) changes.push(`Tuxum narxi: Ayirildi ${oldData.eggPrice}`);
          else changes.push(`Tuxum narxi: ${oldData.eggPrice || 0} → ${eggPrice}`);
        }
        // Telefon
        if ((oldData.phone || "") !== phone) {
          if (!oldData.phone && phone) changes.push(`Telefon: Qo‘shildi "${phone}"`);
          else if (oldData.phone && !phone) changes.push(`Telefon: Ayirildi "${oldData.phone}"`);
          else changes.push(`Telefon: "${oldData.phone || ""}" → "${phone}"`);
        }
        // Tuxum turi
        if ((oldData.eggType || "") !== eggType) {
          if (!oldData.eggType && eggType) changes.push(`Tuxum turi: Qo‘shildi "${eggType}"`);
          else if (oldData.eggType && !eggType) changes.push(`Tuxum turi: Ayirildi "${oldData.eggType}"`);
          else changes.push(`Tuxum turi: "${oldData.eggType || ""}" → "${eggType}"`);
        }

        let action = changes.length ? "O‘zgartirildi: " + changes.join(", ") : "O‘zgartirishda o‘zgarish yo‘q";
        const newHistory = (oldData.history || []);
        newHistory.push({ date: dateStr, action });
        db.collection('debts').doc(editId).update({
          name, amount, eggs, eggPrice, phone, eggType, history: newHistory
        }).then(() => {
          document.getElementById('editModal').style.display = 'none';
          loadDebts();
        });
      });
    }

    function cancelEdit() {
      document.getElementById('editModal').style.display = 'none';
    }

    function displayDebts() {
      const listDiv = document.getElementById('debtList');
      const search = (document.getElementById('searchInput')?.value || "").toLowerCase();
      listDiv.innerHTML = "";
      for (const [id, data] of Object.entries(debts)) {
        if (search && !data.name.toLowerCase().includes(search)) continue;
        const eggSum = (data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0;
        const total = (data.amount || 0) + eggSum;

        // Karta uchun unique id
        const cardId = `card-${id}`;

        listDiv.innerHTML += `
          <div id="${cardId}" class="bg-white border p-6 rounded-xl shadow relative text-lg flex flex-col gap-2 transition-all">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-2xl font-bold">${data.name}</h3>
              <button onclick="showProfile('${id}')" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-base font-bold">Profile</button>
            </div>
            <p class="font-bold">Umumiy qarz: <span class="text-purple-700">${total} so'm</span></p>
            <div id="details-${id}" style="display:none;" class="mt-2 mb-2 text-base">
              <p><b>Pul qarzi:</b> ${data.amount || 0} so'm</p>
              <p><b>Tuxum soni:</b> ${data.eggs || 0} ta</p>
              <p><b>Tuxum narxi:</b> ${data.eggPrice || 0} so'm</p>
              <p><b>Jami tuxum summasi:</b> ${(data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0} so'm</p>
              <p><b>Tuxum turi:</b> ${data.eggType || ""}</p>
              <p><b>Telefon:</b> ${data.phone || ""}</p>
            </div>
            <div id="actions-${id}" style="display:none;" class="mt-4">
              <div class="relative">
                <button onclick="toggleActionsMenu('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-lg font-bold w-full flex items-center justify-center gap-2">
                  O'zgartirishlar
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                </button>
                <div id="actions-menu-${id}" class="actions-menu absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg py-1 hidden">
                  <button onclick="showAddModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Qo'shish</button>
                  <button onclick="showSubtractModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ayirish</button>
                  <button onclick="showEditModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tahrirlash</button>
                  <button onclick="showDeleteConfirm('${id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">O'chirish</button>
                  <button onclick="showHistory('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tarix</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    }

    // Profile tugmasi bosilganda karta stili, barcha ma'lumot va actionlar ko‘rinishi
    function showProfile(id) {
      // Barcha kartalardan active class, action va detailslarni olib tashlash
      Object.keys(debts).forEach(debtId => {
        const card = document.getElementById(`card-${debtId}`);
        const actions = document.getElementById(`actions-${debtId}`);
        const details = document.getElementById(`details-${debtId}`);
        if (card) card.classList.remove('ring-4', 'ring-blue-400', 'bg-blue-50');
        if (actions) actions.style.display = 'none';
        if (details) details.style.display = 'none';
      });
      // Tanlangan kartaga style, action va detailslarni qo‘shish
      const card = document.getElementById(`card-${id}`);
      const actions = document.getElementById(`actions-${id}`);
      const details = document.getElementById(`details-${id}`);
      if (card) card.classList.add('ring-4', 'ring-blue-400', 'bg-blue-50');
      if (actions) actions.style.display = 'flex';
      if (details) details.style.display = 'block';
    }

    function showHistory(id) {
      const data = debts[id];
      const history = data.history || [];
      let html = "";
      if (history.length === 0) {
        html = "<p>O‘zgarishlar tarixi yo‘q.</p>";
      } else {
        history.slice().reverse().forEach(item => {
          if (item.action.startsWith("O‘zgartirildi:")) {
            const changes = item.action.replace("O‘zgartirildi: ", "").split(", ");
            changes.forEach(change => {
              html += `
            <div class="history-item">
              <div class="history-date">${item.date}</div>
              <div class="history-action">${change}</div>
            </div>
          `;
            });
          } else {
            html += `
          <div class="history-item">
            <div class="history-date">${item.date}</div>
            <div class="history-action">${item.action}</div>
          </div>
        `;
          }
        });
      }
      document.getElementById('historyList').innerHTML = html;
      document.getElementById('historyModal').style.display = 'flex';
    }

    function closeHistory() {
      document.getElementById('historyModal').style.display = 'none';
    }
  </script>

  <div id="historyModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-xl w-11/12 max-w-lg text-center">
      <h3 class="mb-4 text-lg sm:text-xl font-semibold">O‘zgarishlar tarixi</h3>
      <div id="historyList" class="text-left max-h-96 overflow-y-auto"></div>
      <button onclick="closeHistory()" class="mt-6 bg-gray-400 text-white px-6 py-3 rounded-xl text-base font-bold">Yopish</button>
    </div>
  </div>

  <!-- Qo‘shish modalida -->
<div id="addModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl w-11/12 max-w-sm text-center">
    <h3 class="mb-4 text-lg font-semibold">Qiymat qo‘shish</h3>
    <input id="addAmount" type="number" placeholder="Pul miqdori" class="border p-3 rounded-xl mb-2 w-full" />
    <input id="addEggs" type="number" placeholder="Tuxum soni" class="border p-3 rounded-xl mb-2 w-full" />
    <input id="addEggPrice" type="number" placeholder="Tuxum narxi" class="border p-3 rounded-xl mb-4 w-full" />
    <div class="flex gap-4 justify-center">
      <button onclick="addValues()" class="bg-green-600 text-white px-6 py-3 rounded-xl text-base font-bold">Qo‘shish</button>
      <button onclick="closeAddModal()" class="bg-gray-400 text-white px-6 py-3 rounded-xl text-base font-bold">Bekor</button>
    </div>
  </div>
</div>

<!-- Ayirish modalida -->
<div id="subtractModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl w-11/12 max-w-sm text-center">
    <h3 class="mb-4 text-lg font-semibold">Qiymat ayirish</h3>
    <input id="subtractAmount" type="number" placeholder="Pul miqdori" class="border p-3 rounded-xl mb-2 w-full" />
    <input id="subtractEggs" type="number" placeholder="Tuxum soni" class="border p-3 rounded-xl mb-2 w-full" />
    <input id="subtractEggPrice" type="number" placeholder="Tuxum narxi" class="border p-3 rounded-xl mb-4 w-full" />
    <div class="flex gap-4 justify-center">
      <button onclick="subtractValues()" class="bg-red-500 text-white px-6 py-3 rounded-xl text-base font-bold">Ayirish</button>
      <button onclick="closeSubtractModal()" class="bg-gray-400 text-white px-6 py-3 rounded-xl text-base font-bold">Bekor</button>
    </div>
  </div>
</div>

<script>
// 1 daqiqada faqat 1 marta bosish uchun flaglar
let addDisabled = false;
let subtractDisabled = false;

function displayDebts() {
  const listDiv = document.getElementById('debtList');
  const search = (document.getElementById('searchInput')?.value || "").toLowerCase();
  listDiv.innerHTML = "";
  for (const [id, data] of Object.entries(debts)) {
    if (search && !data.name.toLowerCase().includes(search)) continue;
    const eggSum = (data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0;
    const total = (data.amount || 0) + eggSum;

    listDiv.innerHTML += `
      <div id="card-${id}" class="bg-white border p-6 rounded-xl shadow relative text-lg flex flex-col gap-2 transition-all">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold">${data.name}</h3>
          <button onclick="showProfile('${id}')" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-base font-bold">Profile</button>
        </div>
        <p class="font-bold">Umumiy qarz: <span class="text-purple-700">${total} so'm</span></p>
        <div id="details-${id}" style="display:none;" class="mt-2 mb-2 text-base">
          <p><b>Pul qarzi:</b> ${data.amount || 0} so'm</p>
          <p><b>Tuxum soni:</b> ${data.eggs || 0} ta</p>
          <p><b>Tuxum narxi:</b> ${data.eggPrice || 0} so'm</p>
          <p><b>Jami tuxum summasi:</b> ${(data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0} so'm</p>
          <p><b>Tuxum turi:</b> ${data.eggType || ""}</p>
          <p><b>Telefon:</b> ${data.phone || ""}</p>
        </div>
        <div id="actions-${id}" style="display:none;" class="mt-4">
          <div class="relative">
            <button onclick="toggleActionsMenu('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-lg font-bold w-full flex items-center justify-center gap-2">
              O'zgartirishlar
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="actions-menu-${id}" class="actions-menu absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg py-1 hidden">
              <button onclick="showAddModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Qo'shish</button>
              <button onclick="showSubtractModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ayirish</button>
              <button onclick="showEditModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tahrirlash</button>
              <button onclick="showDeleteConfirm('${id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">O'chirish</button>
              <button onclick="showHistory('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tarix</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}
function toggleEditActions(id) {
  editId = id;
  const container = document.getElementById('edit-actions-' + id);
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function addValues() {
  if (addDisabled) return;
  addDisabled = true;
  const addBtn = document.querySelector('#addModal button[onclick="addValues()"]');
  if (addBtn) {
    addBtn.disabled = true;
    addBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    addDisabled = false;
    if (addBtn) {
      addBtn.disabled = false;
      addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const addAmount = parseFloat(document.getElementById('addAmount').value) || 0;
  const addEggs = parseInt(document.getElementById('addEggs').value) || 0;
  const addEggPrice = parseFloat(document.getElementById('addEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = (data.amount || 0) + addAmount;
    const updatedEggs = (data.eggs || 0) + addEggs;
    const updatedEggPrice = addEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (addAmount) action.push(`Pul: +${addAmount}`);
    if (addEggs) action.push(`Tuxum: +${addEggs}`);
    if (addEggPrice) action.push(`Tuxum narxi: +${addEggPrice}`);
    newHistory.push({ date: dateStr, action: "Qo‘shildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}

function subtractValues() {
  if (subtractDisabled) return;
  subtractDisabled = true;
  const subBtn = document.querySelector('#subtractModal button[onclick="subtractValues()"]');
  if (subBtn) {
    subBtn.disabled = true;
    subBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    subtractDisabled = false;
    if (subBtn) {
      subBtn.disabled = false;
      subBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const subAmount = parseFloat(document.getElementById('subtractAmount').value) || 0;
  const subEggs = parseInt(document.getElementById('subtractEggs').value) || 0;
  const subEggPrice = parseFloat(document.getElementById('subtractEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = Math.max(0, (data.amount || 0) - subAmount);
    const updatedEggs = Math.max(0, (data.eggs || 0) - subEggs);
    const updatedEggPrice = subEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (subAmount) action.push(`Pul: -${subAmount}`);
    if (subEggs) action.push(`Tuxum: -${subEggs}`);
    if (subEggPrice) action.push(`Tuxum narxi: -${subEggPrice}`);
    newHistory.push({ date: dateStr, action: "Ayirildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('subtractModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}
</script>
<script>
  function displayDebts() {
  const listDiv = document.getElementById('debtList');
  const search = (document.getElementById('searchInput')?.value || "").toLowerCase();
  listDiv.innerHTML = "";
  for (const [id, data] of Object.entries(debts)) {
    if (search && !data.name.toLowerCase().includes(search)) continue;
    const eggSum = (data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0;
    const total = (data.amount || 0) + eggSum;

    listDiv.innerHTML += `
      <div id="card-${id}" class="bg-white border p-6 rounded-xl shadow relative text-lg flex flex-col gap-2 transition-all">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold">${data.name}</h3>
          <button onclick="showProfile('${id}')" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-base font-bold">Profile</button>
        </div>
        <p class="font-bold">Umumiy qarz: <span class="text-purple-700">${total} so'm</span></p>
        <div id="details-${id}" style="display:none;" class="mt-2 mb-2 text-base">
          <p><b>Pul qarzi:</b> ${data.amount || 0} so'm</p>
          <p><b>Tuxum soni:</b> ${data.eggs || 0} ta</p>
          <p><b>Tuxum narxi:</b> ${data.eggPrice || 0} so'm</p>
          <p><b>Jami tuxum summasi:</b> ${(data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0} so'm</p>
          <p><b>Tuxum turi:</b> ${data.eggType || ""}</p>
          <p><b>Telefon:</b> ${data.phone || ""}</p>
        </div>
        <div id="actions-${id}" style="display:none;" class="mt-4">
          <div class="relative">
            <button onclick="toggleActionsMenu('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-lg font-bold w-full flex items-center justify-center gap-2">
              O'zgartirishlar
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="actions-menu-${id}" class="actions-menu absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg py-1 hidden">
              <button onclick="showAddModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Qo'shish</button>
              <button onclick="showSubtractModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ayirish</button>
              <button onclick="showEditModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tahrirlash</button>
              <button onclick="showDeleteConfirm('${id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">O'chirish</button>
              <button onclick="showHistory('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tarix</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}
function toggleEditActions(id) {
  editId = id;
  const container = document.getElementById('edit-actions-' + id);
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function addValues() {
  if (addDisabled) return;
  addDisabled = true;
  const addBtn = document.querySelector('#addModal button[onclick="addValues()"]');
  if (addBtn) {
    addBtn.disabled = true;
    addBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    addDisabled = false;
    if (addBtn) {
      addBtn.disabled = false;
      addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const addAmount = parseFloat(document.getElementById('addAmount').value) || 0;
  const addEggs = parseInt(document.getElementById('addEggs').value) || 0;
  const addEggPrice = parseFloat(document.getElementById('addEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = (data.amount || 0) + addAmount;
    const updatedEggs = (data.eggs || 0) + addEggs;
    const updatedEggPrice = addEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (addAmount) action.push(`Pul: +${addAmount}`);
    if (addEggs) action.push(`Tuxum: +${addEggs}`);
    if (addEggPrice) action.push(`Tuxum narxi: +${addEggPrice}`);
    newHistory.push({ date: dateStr, action: "Qo‘shildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}

function subtractValues() {
  if (subtractDisabled) return;
  subtractDisabled = true;
  const subBtn = document.querySelector('#subtractModal button[onclick="subtractValues()"]');
  if (subBtn) {
    subBtn.disabled = true;
    subBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    subtractDisabled = false;
    if (subBtn) {
      subBtn.disabled = false;
      subBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const subAmount = parseFloat(document.getElementById('subtractAmount').value) || 0;
  const subEggs = parseInt(document.getElementById('subtractEggs').value) || 0;
  const subEggPrice = parseFloat(document.getElementById('subtractEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = Math.max(0, (data.amount || 0) - subAmount);
    const updatedEggs = Math.max(0, (data.eggs || 0) - subEggs);
    const updatedEggPrice = subEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (subAmount) action.push(`Pul: -${subAmount}`);
    if (subEggs) action.push(`Tuxum: -${subEggs}`);
    if (subEggPrice) action.push(`Tuxum narxi: -${subEggPrice}`);
    newHistory.push({ date: dateStr, action: "Ayirildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('subtractModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}
</script>
<script>
  function displayDebts() {
  const listDiv = document.getElementById('debtList');
  const search = (document.getElementById('searchInput')?.value || "").toLowerCase();
  listDiv.innerHTML = "";
  for (const [id, data] of Object.entries(debts)) {
    if (search && !data.name.toLowerCase().includes(search)) continue;
    const eggSum = (data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0;
    const total = (data.amount || 0) + eggSum;

    listDiv.innerHTML += `
      <div id="card-${id}" class="bg-white border p-6 rounded-xl shadow relative text-lg flex flex-col gap-2 transition-all">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold">${data.name}</h3>
          <button onclick="showProfile('${id}')" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-base font-bold">Profile</button>
        </div>
        <p class="font-bold">Umumiy qarz: <span class="text-purple-700">${total} so'm</span></p>
        <div id="details-${id}" style="display:none;" class="mt-2 mb-2 text-base">
          <p><b>Pul qarzi:</b> ${data.amount || 0} so'm</p>
          <p><b>Tuxum soni:</b> ${data.eggs || 0} ta</p>
          <p><b>Tuxum narxi:</b> ${data.eggPrice || 0} so'm</p>
          <p><b>Jami tuxum summasi:</b> ${(data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0} so'm</p>
          <p><b>Tuxum turi:</b> ${data.eggType || ""}</p>
          <p><b>Telefon:</b> ${data.phone || ""}</p>
        </div>
        <div id="actions-${id}" style="display:none;" class="mt-4">
          <div class="relative">
            <button onclick="toggleActionsMenu('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-lg font-bold w-full flex items-center justify-center gap-2">
              O'zgartirishlar
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="actions-menu-${id}" class="actions-menu absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg py-1 hidden">
              <button onclick="showAddModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Qo'shish</button>
              <button onclick="showSubtractModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ayirish</button>
              <button onclick="showEditModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tahrirlash</button>
              <button onclick="showDeleteConfirm('${id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">O'chirish</button>
              <button onclick="showHistory('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tarix</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}
function toggleEditActions(id) {
  editId = id;
  const container = document.getElementById('edit-actions-' + id);
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function addValues() {
  if (addDisabled) return;
  addDisabled = true;
  const addBtn = document.querySelector('#addModal button[onclick="addValues()"]');
  if (addBtn) {
    addBtn.disabled = true;
    addBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    addDisabled = false;
    if (addBtn) {
      addBtn.disabled = false;
      addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const addAmount = parseFloat(document.getElementById('addAmount').value) || 0;
  const addEggs = parseInt(document.getElementById('addEggs').value) || 0;
  const addEggPrice = parseFloat(document.getElementById('addEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = (data.amount || 0) + addAmount;
    const updatedEggs = (data.eggs || 0) + addEggs;
    const updatedEggPrice = addEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (addAmount) action.push(`Pul: +${addAmount}`);
    if (addEggs) action.push(`Tuxum: +${addEggs}`);
    if (addEggPrice) action.push(`Tuxum narxi: +${addEggPrice}`);
    newHistory.push({ date: dateStr, action: "Qo‘shildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}

function subtractValues() {
  if (subtractDisabled) return;
  subtractDisabled = true;
  const subBtn = document.querySelector('#subtractModal button[onclick="subtractValues()"]');
  if (subBtn) {
    subBtn.disabled = true;
    subBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    subtractDisabled = false;
    if (subBtn) {
      subBtn.disabled = false;
      subBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const subAmount = parseFloat(document.getElementById('subtractAmount').value) || 0;
  const subEggs = parseInt(document.getElementById('subtractEggs').value) || 0;
  const subEggPrice = parseFloat(document.getElementById('subtractEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = Math.max(0, (data.amount || 0) - subAmount);
    const updatedEggs = Math.max(0, (data.eggs || 0) - subEggs);
    const updatedEggPrice = subEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (subAmount) action.push(`Pul: -${subAmount}`);
    if (subEggs) action.push(`Tuxum: -${subEggs}`);
    if (subEggPrice) action.push(`Tuxum narxi: -${subEggPrice}`);
    newHistory.push({ date: dateStr, action: "Ayirildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('subtractModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}
</script>
<script>
  function displayDebts() {
  const listDiv = document.getElementById('debtList');
  const search = (document.getElementById('searchInput')?.value || "").toLowerCase();
  listDiv.innerHTML = "";
  for (const [id, data] of Object.entries(debts)) {
    if (search && !data.name.toLowerCase().includes(search)) continue;
    const eggSum = (data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0;
    const total = (data.amount || 0) + eggSum;

    listDiv.innerHTML += `
      <div id="card-${id}" class="bg-white border p-6 rounded-xl shadow relative text-lg flex flex-col gap-2 transition-all">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold">${data.name}</h3>
          <button onclick="showProfile('${id}')" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-base font-bold">Profile</button>
        </div>
        <p class="font-bold">Umumiy qarz: <span class="text-purple-700">${total} so'm</span></p>
        <div id="details-${id}" style="display:none;" class="mt-2 mb-2 text-base">
          <p><b>Pul qarzi:</b> ${data.amount || 0} so'm</p>
          <p><b>Tuxum soni:</b> ${data.eggs || 0} ta</p>
          <p><b>Tuxum narxi:</b> ${data.eggPrice || 0} so'm</p>
          <p><b>Jami tuxum summasi:</b> ${(data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0} so'm</p>
          <p><b>Tuxum turi:</b> ${data.eggType || ""}</p>
          <p><b>Telefon:</b> ${data.phone || ""}</p>
        </div>
        <div id="actions-${id}" style="display:none;" class="mt-4">
          <div class="relative">
            <button onclick="toggleActionsMenu('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-lg font-bold w-full flex items-center justify-center gap-2">
              O'zgartirishlar
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="actions-menu-${id}" class="actions-menu absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg py-1 hidden">
              <button onclick="showAddModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Qo'shish</button>
              <button onclick="showSubtractModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ayirish</button>
              <button onclick="showEditModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tahrirlash</button>
              <button onclick="showDeleteConfirm('${id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">O'chirish</button>
              <button onclick="showHistory('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tarix</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}
function toggleEditActions(id) {
  editId = id;
  const container = document.getElementById('edit-actions-' + id);
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function addValues() {
  if (addDisabled) return;
  addDisabled = true;
  const addBtn = document.querySelector('#addModal button[onclick="addValues()"]');
  if (addBtn) {
    addBtn.disabled = true;
    addBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    addDisabled = false;
    if (addBtn) {
      addBtn.disabled = false;
      addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const addAmount = parseFloat(document.getElementById('addAmount').value) || 0;
  const addEggs = parseInt(document.getElementById('addEggs').value) || 0;
  const addEggPrice = parseFloat(document.getElementById('addEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = (data.amount || 0) + addAmount;
    const updatedEggs = (data.eggs || 0) + addEggs;
    const updatedEggPrice = addEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (addAmount) action.push(`Pul: +${addAmount}`);
    if (addEggs) action.push(`Tuxum: +${addEggs}`);
    if (addEggPrice) action.push(`Tuxum narxi: +${addEggPrice}`);
    newHistory.push({ date: dateStr, action: "Qo‘shildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}

function subtractValues() {
  if (subtractDisabled) return;
  subtractDisabled = true;
  const subBtn = document.querySelector('#subtractModal button[onclick="subtractValues()"]');
  if (subBtn) {
    subBtn.disabled = true;
    subBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    subtractDisabled = false;
    if (subBtn) {
      subBtn.disabled = false;
      subBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const subAmount = parseFloat(document.getElementById('subtractAmount').value) || 0;
  const subEggs = parseInt(document.getElementById('subtractEggs').value) || 0;
  const subEggPrice = parseFloat(document.getElementById('subtractEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = Math.max(0, (data.amount || 0) - subAmount);
    const updatedEggs = Math.max(0, (data.eggs || 0) - subEggs);
    const updatedEggPrice = subEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (subAmount) action.push(`Pul: -${subAmount}`);
    if (subEggs) action.push(`Tuxum: -${subEggs}`);
    if (subEggPrice) action.push(`Tuxum narxi: -${subEggPrice}`);
    newHistory.push({ date: dateStr, action: "Ayirildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('subtractModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}
</script>
<script>
  function displayDebts() {
  const listDiv = document.getElementById('debtList');
  const search = (document.getElementById('searchInput')?.value || "").toLowerCase();
  listDiv.innerHTML = "";
  for (const [id, data] of Object.entries(debts)) {
    if (search && !data.name.toLowerCase().includes(search)) continue;
    const eggSum = (data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0;
    const total = (data.amount || 0) + eggSum;

    listDiv.innerHTML += `
      <div id="card-${id}" class="bg-white border p-6 rounded-xl shadow relative text-lg flex flex-col gap-2 transition-all">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold">${data.name}</h3>
          <button onclick="showProfile('${id}')" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-base font-bold">Profile</button>
        </div>
        <p class="font-bold">Umumiy qarz: <span class="text-purple-700">${total} so'm</span></p>
        <div id="details-${id}" style="display:none;" class="mt-2 mb-2 text-base">
          <p><b>Pul qarzi:</b> ${data.amount || 0} so'm</p>
          <p><b>Tuxum soni:</b> ${data.eggs || 0} ta</p>
          <p><b>Tuxum narxi:</b> ${data.eggPrice || 0} so'm</p>
          <p><b>Jami tuxum summasi:</b> ${(data.eggs && data.eggPrice) ? data.eggs * data.eggPrice : 0} so'm</p>
          <p><b>Tuxum turi:</b> ${data.eggType || ""}</p>
          <p><b>Telefon:</b> ${data.phone || ""}</p>
        </div>
        <div id="actions-${id}" style="display:none;" class="mt-4">
          <div class="relative">
            <button onclick="toggleActionsMenu('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-lg font-bold w-full flex items-center justify-center gap-2">
              O'zgartirishlar
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="actions-menu-${id}" class="actions-menu absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg py-1 hidden">
              <button onclick="showAddModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Qo'shish</button>
              <button onclick="showSubtractModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ayirish</button>
              <button onclick="showEditModal('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tahrirlash</button>
              <button onclick="showDeleteConfirm('${id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">O'chirish</button>
              <button onclick="showHistory('${id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tarix</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}
function toggleEditActions(id) {
  editId = id;
  const container = document.getElementById('edit-actions-' + id);
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function addValues() {
  if (addDisabled) return;
  addDisabled = true;
  const addBtn = document.querySelector('#addModal button[onclick="addValues()"]');
  if (addBtn) {
    addBtn.disabled = true;
    addBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    addDisabled = false;
    if (addBtn) {
      addBtn.disabled = false;
      addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const addAmount = parseFloat(document.getElementById('addAmount').value) || 0;
  const addEggs = parseInt(document.getElementById('addEggs').value) || 0;
  const addEggPrice = parseFloat(document.getElementById('addEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = (data.amount || 0) + addAmount;
    const updatedEggs = (data.eggs || 0) + addEggs;
    const updatedEggPrice = addEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (addAmount) action.push(`Pul: +${addAmount}`);
    if (addEggs) action.push(`Tuxum: +${addEggs}`);
    if (addEggPrice) action.push(`Tuxum narxi: +${addEggPrice}`);
    newHistory.push({ date: dateStr, action: "Qo‘shildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}

function subtractValues() {
  if (subtractDisabled) return;
  subtractDisabled = true;
  const subBtn = document.querySelector('#subtractModal button[onclick="subtractValues()"]');
  if (subBtn) {
    subBtn.disabled = true;
    subBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  setTimeout(() => {
    subtractDisabled = false;
    if (subBtn) {
      subBtn.disabled = false;
      subBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }, 60000); // 60 sekund

  if (!editId) return;

  const subAmount = parseFloat(document.getElementById('subtractAmount').value) || 0;
  const subEggs = parseInt(document.getElementById('subtractEggs').value) || 0;
  const subEggPrice = parseFloat(document.getElementById('subtractEggPrice')?.value) || 0;
  const now = new Date();
  const dateStr = now.toLocaleString('uz-UZ');

  db.collection('debts').doc(editId).get().then(doc => {
    const data = doc.data();
    if (!data) return;

    const updatedAmount = Math.max(0, (data.amount || 0) - subAmount);
    const updatedEggs = Math.max(0, (data.eggs || 0) - subEggs);
    const updatedEggPrice = subEggPrice || data.eggPrice || 0;

    const newHistory = (data.history || []);
    let action = [];
    if (subAmount) action.push(`Pul: -${subAmount}`);
    if (subEggs) action.push(`Tuxum: -${subEggs}`);
    if (subEggPrice) action.push(`Tuxum narxi: -${subEggPrice}`);
    newHistory.push({ date: dateStr, action: "Ayirildi: " + action.join(", ") });

    db.collection('debts').doc(editId).update({
      amount: updatedAmount,
      eggs: updatedEggs,
      eggPrice: updatedEggPrice,
      history: newHistory
    }).then(() => {
      document.getElementById('subtractModal').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      loadDebts();
    });
  });
}
</script>

  